<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Post Data</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src ="static/StackedAreaChart.js"></script>
</head>
<body>
    <h1>POST DATA</h1>
    <div id="post-text" style="width: 300; height: 200;"></div>
    <div id="post-viz"></div>

    <script>

    var runQuery = function (query, cbfun) {
	console.log("in runQuery: query is " + query);

	var url = '/data';

	var headers = new Headers();
	headers.append('Content-Type', 'application/json');

	var fetchData = {
		method : 'POST',
		body : JSON.stringify({'query' : query}),
		headers : headers
	}

	fetch(url, fetchData)
		.then((resp) => resp.json())
		.then(function(data) {
			cbfun(data);
		})
		.catch(function (error) {
			console.log('Error: ' + Error);
		});

	console.log('After fetch call');

    }

        var nbrhoods = ["Palace Hills","Northwest", "Old Town", "Safe Town", "Southwest", "Downtown", "Wilson Forest", "Scenic Vista", "Broadview", "Chapparal", "Terrapin Springs", "Cheddarford", "Easton", "Weston", "Southton", "Oak Willow", "East Parton", "West Parton"];


        var constructSQL = function() {
            return `SELECT * FROM repost_occurences WHERE post_ID = ${6942}`;
        }


        var constructSQL_post = function(id) {
            return `SELECT * FROM posts WHERE ID = ${6942}`;
        }

        var createviz = function(data) {
            var repost_data = data;
            console.log(data)

            var postID = data[0].post_id;
            var post_data = null;

            var get_post = function(pdata){
                post_data = pdata
                console.log(post_data)

                post_text(post_data);
                create(repost_data);
            }
            runQuery(constructSQL_post(postID),get_post);
        }
        runQuery(constructSQL(), createviz);


        var post_text = function(data){

            var node = document.createElement("H2");        
            var textnode = document.createTextNode(`${data[0].post_text}`); 
            node.appendChild(textnode);

            document.getElementById("post-text").appendChild(node);
        }

        var create = function(repost_data){
            var layers = []
            var categories =[];

            repost_data.forEach((element, i) =>{
                categories[i]= {};
                nbrhoods.forEach(element =>{
                    categories[i][`${element}`] = 0;
                })
                categories[i][`Year`] = "";
            });


            repost_data.forEach((element, i) => {
                var year = new Date(element.timestmp.toString());
                
                categories[i][`${element.neighbourhood}`]++;
                categories[i][`Year`] = year;
            });

            layers.push(categories)
            console.log(categories)
            areachart = new StackedAreaChart("post-viz", layers);
        }
     
     
     </script>
</body>